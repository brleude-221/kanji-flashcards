<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Kanji Flashcards</title>

<style>
body{
  font-family:sans-serif;
  display:flex;
  gap:30px;
  padding:20px;
}

#main{
  width:100%;
  text-align:center;
}

#side{
  width:40%;
  border-left:1px solid #ccc;
  padding-left:15px;
  max-height:80vh;
  overflow-y:auto;
}

/* -------- BUTTON + FILE INPUT UNIFORM STYLE -------- */

.button-like {
  display:inline-block;
  padding:6px 12px;
  background:#f0f0f0;
  border:1px solid #ccc;
  border-radius:4px;
  cursor:pointer;
  text-transform: lowercase;
  font-size:16px;
  margin:5px;
}

button{
  padding:6px 12px;
  background:#f0f0f0;
  border:1px solid #ccc;
  border-radius:4px;
  cursor:pointer;
  text-transform: lowercase;
  font-size:16px;
  margin:5px;
}

input[type="file"]{
  display:none;
}

/* -------------------- */

.card{
  font-size:40px;
  margin:40px auto;
  cursor:pointer;
  user-select:none;
}

.meaning{
  font-size:20px;
  color:#444;
  margin-top:10px;
  min-height:24px;
  cursor:pointer;
}

select{
  font-size:16px;
  margin:5px;
  text-transform: lowercase;
}

#saveContainer{
  text-align:center;
  margin-top:10px;
}

table{
  width:100%;
  border-collapse:collapse;
  font-size:14px;
}

th,td{
  border:1px solid #ccc;
  padding:4px;
}

hr{ margin:20px 0; }
</style>
</head>

<body>

<div id="main">

<h2>Kanji Flashcards</h2>

<!-- Local upload (now lowercase + matching style) -->
<label class="button-like" for="fileInput">choose file</label>
<input type="file" id="fileInput">

<br>

<!-- GitHub Loader: button identical to choose file -->
<label class="button-like" onclick="loadFromGithub()">load from github</label>
<select id="githubSelect"></select>

<hr>

Mode:
<select id="modeSelect">
  <option value="k2r">kanji → reading</option>
  <option value="r2k">reading → kanji</option>
</select>

<div>
Total: <span id="total">0</span> |
Round: <span id="seen">0</span> |
Words Left: <span id="left">0</span>
</div>

<div class="card" id="card" onclick="handleCardClick()">
Load a CSV
</div>

<button onclick="toggleMeaning()">meaning</button>
<div class="meaning" id="meaning" onclick="meaningClick()"></div>

<button onclick="know()">know</button>
<button onclick="dontKnow()">don't know</button>
<button onclick="undo()">undo</button>

<hr>

<button onclick="toggleSide()">hide unknown</button>

</div>

<div id="side">
<h3 id="unknownTitle">Unknown</h3>
<table>
<thead>
<tr>
<th>Kanji</th>
<th>Reading</th>
<th>Meaning</th>
</tr>
</thead>
<tbody id="unknownTable"></tbody>
</table>

<div id="saveContainer">
  <button onclick="saveUnknown()">save</button>
</div>

</div>

<script>

let allCards=[];
let newCards=[];
let roundQueue=[];
let unknownMap=new Map();

let index=0;
let meaningVisible=false;
let showingFront=true;

let historyStack=[];
let originalFileName="";

/* -------------------------------
   LOAD CSV FROM GITHUB
-------------------------------- */

const githubFolderURL =
  "https://api.github.com/repos/brleude-221/kanji-flashcards/contents/csv";

async function loadGithubList(){
  const res = await fetch(githubFolderURL);
  const files = await res.json();

  githubSelect.innerHTML = "";

  files
    .filter(f => f.name.endsWith(".csv"))
    .forEach(f=>{
      const opt = document.createElement("option");
      opt.value = f.download_url;
      opt.textContent = f.name;
      githubSelect.appendChild(opt);
    });
}

loadGithubList();

/* Load selected GitHub CSV */
async function loadFromGithub(){
  const url = githubSelect.value;
  originalFileName = githubSelect.selectedOptions[0].textContent.replace(".csv","");

  const res = await fetch(url);
  const text = await res.text();

  const rows = text.trim().split("\n").map(r=>r.split(","));
  allCards = rows.map(r=>({data:r,seen:0}));

  resetSession();
  show();
}

/* -------------------------------
   LOAD CSV FROM USER UPLOAD
-------------------------------- */

fileInput.addEventListener("change",e=>{
  const file = e.target.files[0];
  if(!file) return;

  originalFileName = file.name.replace(/\.[^/.]+$/, "");

  const reader=new FileReader();
  reader.onload=()=>{
    const rows=reader.result.trim().split("\n").map(r=>r.split(","));
    allCards=rows.map(r=>({data:r,seen:0}));
    resetSession();
    show();
  };
  reader.readAsText(file);
});

/* -------------------------------
   MODE RESET
-------------------------------- */

modeSelect.addEventListener("change",()=>{
  resetSession();
  updateUnknownTitle();
  show();
});

/* -------------------------------
   RESET SESSION
-------------------------------- */

function resetSession(){
  newCards=[...allCards];
  shuffle(newCards);
  roundQueue=[];
  unknownMap.clear();
  historyStack=[];
  index=0;
  startNextRound();
  renderUnknownTable();
}

/* -------------------------------
   ROUNDS
-------------------------------- */

function startNextRound(){
  if(newCards.length>0){
    roundQueue=[...newCards];
    newCards=[];
  }else{
    roundQueue=[...unknownMap.values()];
  }
  shuffle(roundQueue);
  index=0;
}

/* -------------------------------
   DISPLAY
-------------------------------- */

function show(){
  if(roundQueue.length===0){
    card.textContent=":)";
    meaning.textContent="";
    total.textContent=0;
    left.textContent=0;
    renderUnknownTable();
    return;
  }

  const c=roundQueue[index];
  c.seen++;

  showingFront=true;
  meaning.textContent="";
  meaningVisible=false;

  updateCardText();
  updateUnknownTitle();

  total.textContent=roundQueue.length;
  seen.textContent=c.seen-1;
  left.textContent=roundQueue.length-index;

  renderUnknownTable();
}

/* -------------------------------
   CARD FLIP
-------------------------------- */

function updateCardText(){
  const c=roundQueue[index];

  if(modeSelect.value==="k2r"){
    card.textContent = showingFront ? c.data[0] : c.data[1];
  }else{
    card.textContent = showingFront ? c.data[1] : c.data[0];
  }
}

function handleCardClick(){
  if(roundQueue.length===0){
    card.textContent = card.textContent === ":)" ? "(:"
                                                 : ":)";
    return;
  }
  showingFront=!showingFront;
  updateCardText();
}

/* -------------------------------
   MEANING
-------------------------------- */

function toggleMeaning(){
  if(roundQueue.length===0){
    meaning.textContent="you did good!";
    return;
  }

  const c=roundQueue[index];
  meaning.textContent = meaningVisible ? "" : c.data[2];
  meaningVisible = !meaningVisible;
}

/* -------------------------------
   KNOW / DON'T KNOW
-------------------------------- */

function know(){
  if(roundQueue.length===0) return;
  const c=roundQueue[index];

  historyStack.push({card:c, action:"know", wasUnknown:unknownMap.has(c.data.join(","))});
  unknownMap.delete(c.data.join(","));
  nextCard();
}

function dontKnow(){
  if(roundQueue.length===0) return;
  const c=roundQueue[index];

  historyStack.push({card:c, action:"dontKnow"});
  unknownMap.set(c.data.join(","),c);
  nextCard();
}

/* -------------------------------
   UNDO
-------------------------------- */

function undo(){
  if(historyStack.length===0) return;

  index = Math.max(0, index - 1);

  const last = historyStack.pop();
  const c = last.card;
  const key = c.data.join(",");

  if(last.action==="know"){
    if(last.wasUnknown){
      unknownMap.set(key,c);
    }
  }

  if(last.action==="dontKnow"){
    unknownMap.delete(key);
  }

  show();
}

/* -------------------------------
   NEXT CARD
-------------------------------- */

function nextCard(){
  index++;
  if(index>=roundQueue.length){
    startNextRound();
  }
  show();
}

/* -------------------------------
   SIDEBAR
-------------------------------- */

function toggleSide(){
  if(side.style.display==="none"){
    side.style.display="block";
    event.target.textContent="hide unknown";
  }else{
    side.style.display="none";
    event.target.textContent="show unknown";
  }
}

function updateUnknownTitle(){
  unknownTitle.textContent =
    modeSelect.value==="k2r" ? "Unknown Reading" : "Unknown Kanji";
}

function renderUnknownTable(){
  unknownTable.innerHTML="";

  if(unknownMap.size===0) return;

  unknownMap.forEach(c=>{
    const tr=document.createElement("tr");
    c.data.forEach(v=>{
      const td=document.createElement("td");
      td.textContent=v;
      tr.appendChild(td);
    });
    unknownTable.appendChild(tr);
  });
}

/* -------------------------------
   SAVE UNKNOWN CSV
-------------------------------- */

function saveUnknown(){
  if(unknownMap.size===0){
    alert("No unknown words to save.");
    return;
  }

  let csv = "";
  unknownMap.forEach(c=>{
    csv += c.data.join(",") + "\n";
  });

  const blob = new Blob([csv],{type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");

  let suffix = modeSelect.value === "k2r"
    ? "_unknown_reading"
    : "_unknown_kanji";

  a.href = url;
  a.download = originalFileName + suffix + ".csv";
  a.click();

  URL.revokeObjectURL(url);
}

/* -------------------------------
   SHUFFLE
-------------------------------- */

function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
}

</script>

</body>
</html>

