<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Kanji Flashcards</title>

<style>
body{
  font-family:sans-serif;
  display:flex;
  gap:30px;
  padding:20px;
}

#main{
  width:100%;
  text-align:center;
}

#side{
  width:40%;
  border-left:1px solid #ccc;
  padding-left:15px;
  max-height:80vh;
  overflow-y:auto;
}

.button-like, button{
  display:inline-block;
  padding:6px 12px;
  background:#f0f0f0;
  border:1px solid #ccc;
  border-radius:4px;
  cursor:pointer;
  text-transform: lowercase;
  font-size:16px;
  margin:5px;
}

input[type="file"]{ display:none; }

.card{
  font-size:40px;
  margin:40px auto;
  cursor:pointer;
  user-select:none;
}

.meaning{
  font-size:20px;
  color:#444;
  margin-top:10px;
  min-height:24px;
  cursor:pointer;
}

#sentence{
  font-size:18px;
  color:#333;
  margin-top:10px;
  min-height:24px;
}

select{ font-size:16px; margin:5px; text-transform: lowercase; }

#saveContainer{ text-align:center; margin-top:10px; }

table{
  width:100%;
  border-collapse:collapse;
  font-size:14px;
}

th,td{
  border:1px solid #ccc;
  padding:4px;
}

hr{ margin:20px 0; }
.hidden{ display:none; }
</style>
</head>

<body>

<div id="main">

<h2>Kanji Flashcards</h2>

<label class="button-like" for="fileInput">choose file</label>
<input type="file" id="fileInput">

<br>

<label class="button-like" onclick="loadFromGithub()">load from github</label>
<select id="githubSelect"></select>

<hr>

Mode:
<select id="modeSelect">
  <option value="k2r">kanji → reading</option>
  <option value="r2k">reading → kanji</option>
</select>

<div>
Total: <span id="total">0</span> |
Round: <span id="seen">0</span> |
Words Left: <span id="left">0</span>
</div>

<div class="card" id="card" onclick="handleCardClick()">Load a CSV</div>

<div id="controls">
  <button onclick="toggleMeaning()">meaning</button>
  <div class="meaning" id="meaning"></div>

  <button id="sentenceBtn" onclick="toggleSentence()" class="hidden">sentence</button>
  <div id="sentence"></div>

  <button onclick="know()">know</button>
  <button onclick="dontKnow()">don't know</button>
  <button onclick="undo()">undo</button>
</div>

<hr>

<button onclick="toggleSide()">hide unknown</button>

</div>

<div id="side">
<h3 id="unknownTitle">Unknown</h3>
<table>
<thead>
<tr>
<th>Kanji</th>
<th>Reading</th>
<th>Meaning</th>
</tr>
</thead>
<tbody id="unknownTable"></tbody>
</table>

<div id="saveContainer">
  <button onclick="saveUnknown()">save</button>
</div>

</div>

<script>
let allCards=[], newCards=[], roundQueue=[];
let unknownMap=new Map();
let index=0, showingFront=true;
let historyStack=[];
let originalFileName="";
let hasSentence=false;
let sentenceVisible=false;

/* ---------- github ---------- */
const githubFolderURL="https://api.github.com/repos/brleude-221/kanji-flashcards/contents/csv";

async function loadGithubList(){
  const res=await fetch(githubFolderURL);
  const files=await res.json();
  githubSelect.innerHTML="";
  files.filter(f=>f.name.endsWith(".csv")).forEach(f=>{
    const opt=document.createElement("option");
    opt.value=f.download_url;
    opt.textContent=f.name;
    githubSelect.appendChild(opt);
  });
}
loadGithubList();

async function loadFromGithub(){
  const res=await fetch(githubSelect.value);
  const text=await res.text();
  originalFileName=githubSelect.selectedOptions[0].textContent.replace(".csv","");
  loadCSV(text);
}

/* ---------- local ---------- */
fileInput.addEventListener("change",e=>{
  const file=e.target.files[0];
  if(!file) return;
  originalFileName=file.name.replace(/\.[^/.]+$/,"");
  const reader=new FileReader();
  reader.onload=()=>loadCSV(reader.result);
  reader.readAsText(file);
});

/* ---------- core ---------- */
function loadCSV(text){
  const rows=text.trim().split("\n").map(r=>r.split(","));
  allCards=rows.map(r=>({data:r,seen:0}));
  hasSentence = rows[0].length >= 4;
  sentenceBtn.classList.toggle("hidden",!hasSentence);
  resetSession();
  show();
}

modeSelect.addEventListener("change",()=>{ resetSession(); show(); });

function resetSession(){
  newCards=[...allCards];
  shuffle(newCards);
  roundQueue=[];
  unknownMap.clear();
  historyStack=[];
  index=0;
  startNextRound();
  controls.classList.remove("hidden");
}

function startNextRound(){
  if(newCards.length) roundQueue=[...newCards], newCards=[];
  else roundQueue=[...unknownMap.values()];
  shuffle(roundQueue);
  index=0;
}

function show(){
  if(roundQueue.length===0){
    card.textContent=":)";
    meaning.textContent="";
    sentence.textContent="";
    controls.classList.add("hidden");
    total.textContent=seen.textContent=left.textContent=0;
    renderUnknownTable();
    return;
  }

  const c=roundQueue[index];
  c.seen++;
  showingFront=true;
  meaning.textContent="";
  sentence.textContent="";
  sentenceVisible=false;
  updateCardText();

  total.textContent=roundQueue.length;
  seen.textContent=c.seen-1;
  left.textContent=roundQueue.length-index;
  updateUnknownTitle();
  renderUnknownTable();
}

function updateCardText(){
  const c=roundQueue[index];
  card.textContent =
    modeSelect.value==="k2r"
      ? (showingFront ? c.data[0] : c.data[1])
      : (showingFront ? c.data[1] : c.data[0]);
}

function handleCardClick(){
  if(roundQueue.length===0){
    card.textContent=card.textContent===":)"?"(:":":)";
    return;
  }
  showingFront=!showingFront;
  updateCardText();
}

/* ---------- meaning ---------- */
function toggleMeaning(){
  if(roundQueue.length===0) return;
  const c=roundQueue[index];
  meaning.textContent = meaning.textContent ? "" : c.data[2];
}

/* ---------- UPDATED SENTENCE LOGIC HERE ---------- */
function toggleSentence(){
  if(!hasSentence || roundQueue.length===0) return;
  const c=roundQueue[index];
  let s = c.data[3];

  if (modeSelect.value === "r2k") {
      const word = c.data[0];      // e.g. 食べる
      const reading = c.data[1];   // e.g. たべる

      // Extract kanji characters only
      const kanjiOnly = [...word].filter(ch => /\p{Script=Han}/u.test(ch)).join("");

      if (kanjiOnly.length > 0) {
          // First part of reading corresponds to kanji count
          const kanaPart = reading.slice(0, kanjiOnly.length);

          // Replace only the kanji sequence
          s = s.replaceAll(kanjiOnly, kanaPart);
      }
  }

  sentence.textContent = sentenceVisible ? "" : s;
  sentenceVisible = !sentenceVisible;
}

/* ---------- know / dont ---------- */
function know(){
  if(!roundQueue.length) return;
  const c=roundQueue[index];
  historyStack.push({card:c,wasUnknown:unknownMap.has(c.data.join(","))});
  unknownMap.delete(c.data.join(","));
  nextCard();
}

function dontKnow(){
  if(!roundQueue.length) return;
  const c=roundQueue[index];
  historyStack.push({card:c,dont:true});
  unknownMap.set(c.data.join(","),c);
  nextCard();
}

function undo(){
  if(!historyStack.length) return;
  index=Math.max(0,index-1);
  const last=historyStack.pop();
  const key=last.card.data.join(",");
  if(last.dont) unknownMap.delete(key);
  else if(last.wasUnknown) unknownMap.set(key,last.card);
  show();
}

function nextCard(){
  index++;
  if(index>=roundQueue.length) startNextRound();
  show();
}

/* ---------- sidebar ---------- */
function toggleSide(){
  side.style.display = side.style.display==="none"?"block":"none";
  event.target.textContent = side.style.display==="none"?"show unknown":"hide unknown";
}

function updateUnknownTitle(){
  unknownTitle.textContent =
    modeSelect.value==="k2r" ? "Unknown Reading" : "Unknown Kanji";
}

function renderUnknownTable(){
  unknownTable.innerHTML="";
  unknownMap.forEach(c=>{
    const tr=document.createElement("tr");
    c.data.slice(0,3).forEach(v=>{
      const td=document.createElement("td");
      td.textContent=v;
      tr.appendChild(td);
    });
    unknownTable.appendChild(tr);
  });
}

/* ---------- save ---------- */
function saveUnknown(){
  if(!unknownMap.size) return alert("No unknown words to save.");
  let csv="";
  unknownMap.forEach(c=>csv+=c.data.join(",")+"\n");
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=originalFileName+(modeSelect.value==="k2r"?"_unknown_reading":"_unknown_kanji")+".csv";
  a.click();
}

/* ---------- util ---------- */
function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
}
</script>

</body>
</html>

